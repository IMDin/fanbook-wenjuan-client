name: build-compiler-main

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    container: tarscloud/base-compiler
    runs-on: ubuntu-20.04
    steps:
      - name: cache node modules
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.ACTION_DEPLOY_KEY }}
          name: ssh_tarstime_key
          known_hosts: ${{ secrets.ACTION_KNOWN_HOSTS }}
          config: ${{ secrets.ACTION_DEPLOY_CONFIG }}
          if_key_exists: replace
      - name: Install Vue
        run: npm install -g vue-cli --registry=https://registry.npm.taobao.org
      - name: Install node-modules
        run: |
          ls -al
          npm install --registry=https://registry.npm.taobao.org
      - name: Webpack dist
        run: npm run build
      - name: scp tgz
        run: |
          mv dist fanbook
          tar -zcvf fanbook.tgz fanbook
          scp -P 22000 fanbook.tgz tarstime:/home/ubuntu/fanbook/
      - name: deploy
        run: ssh -p 22000 tarstime "tar -zxvf /home/ubuntu/fanbook/fanbook.tgz -C /usr/share/nginx/"
